name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    services:
      localstack:
        # Provides local ephemeral versions of AWS services to use during tests.
        #
        # TODO: 0.12.14 introduces a new (undocumented) kinesis mock,
        # and breaks source-kinesis tests for unknown reasons.
        image: localstack/localstack:0.12.13
        env:
          # Only use a limited number of services in order to speed up the startup time.
          SERVICES: "kinesis,s3"
          # Randomly return rate limiting errors from the kinesis api to exercise those code paths.
          KINESIS_ERROR_PROBABILITY: "0.1"
        ports:
          - 4566:4566
          - 4571:4571
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
      - run: make testAll
